version: "3.9"
services:
  paperless:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: athradir-paperless
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/Los_Angeles}
      PAPERLESS_REDIS: redis://redis:6379/${REDIS_DB_PAPERLESS:-0}
      PAPERLESS_DBHOST: postgres
      PAPERLESS_DBNAME: ${ATHRADIR_PAPERLESS_DB_NAME:-paperless}
      PAPERLESS_DBUSER: ${ROOT_USERNAME:-changeMe}
      PAPERLESS_DBPASS: ${ROOT_PASSWORD:-changeMe}
      PAPERLESS_SECRET_KEY: ${ATHRADIR_PAPERLESS_SECRET_KEY:-changeMe}
      PAPERLESS_URL: http://localhost:8000
      PAPERLESS_TIME_ZONE: America/Los_Angeles
      PAPERLESS_OCR_LANGUAGE: eng
      # Enable API for paperless-ai
      PAPERLESS_ENABLE_HTTP_REMOTE_USER: "false"
    networks:
      - gulhir
    ports:
      - ${ATHRADIR_PAPERLESS_PORT:-8000}:8000
    restart: unless-stopped
    volumes:
      - ${ATHRADIR_PAPERLESS_PATH:-./paperless}/data:/usr/src/paperless/data
      - ${ATHRADIR_PAPERLESS_PATH:-./paperless}/export:/usr/src/paperless/export
      - gogiwnadh-paperless-import:/usr/src/paperless/consume
      - gogiwnadh-paperless-media:/usr/src/paperless/media
    depends_on:
      - postgres
      - redis
    deploy:
      placement:
        constraints: [node.hostname == amonvedui]

  paperless-ai:
    image: clusterzx/paperless-ai
    container_name: athradir-paperless-ai
    networks:
      - gulhir
    ports:
      - ${ATHRADIR_PAPERLESS_PORT_AI:-3000}:3000
    restart: unless-stopped
    volumes:
      - ${ATHRADIR_PAPERLESS_PATH:-./paperless}/ai:/app/data
    depends_on:
      - paperless
    deploy:
      placement:
        constraints: [node.hostname == amonvedui]

  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: athradir-immich-server
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/Los_Angeles}
    ports:
      - ${ATHRADIR_IMMICH_PORT:-2283}:2283
    restart: always
    volumes:
      - ${ATHRADIR_IMMICH_PATH:-./immich}/data:/data
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - immich-redis
      - immich-database
    deploy:
      placement:
        constraints: [node.hostname == butharad]

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: athradir-immich-machine-learning
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/Los_Angeles}
    ports:
      - ${ATHRADIR_IMMICH_PORT_ML:-3003}:3003
    restart: always
    volumes:
      - ${ATHRADIR_IMMICH_PATH:-./immich}/cache:/cache
    deploy:
      placement:
        constraints: [node.hostname == butharad]

  immich-redis:
    image: docker.io/valkey/valkey:8@sha256:81db6d39e1bba3b3ff32bd3a1b19a6d69690f94a3954ec131277b9a26b95b3aa
    container_name: athradir-immich-redis
    restart: always

  immich-database:
    container_name: immich_postgres
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:bcf63357191b76a916ae5eb93464d65c07511da41e3bf7a8416db519b40b1c23
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/Los_Angeles}
      POSTGRES_PASSWORD: ${ROOT_PASSWORD:-changeMe}
      POSTGRES_USER: ${ROOT_USERNAME:-changeMe}
      POSTGRES_DB: ${ATHRADIR_IMMICH_DB_NAME:-immich}
      POSTGRES_INITDB_ARGS: "--data-checksums"
    ports:
      - ${ATHRADIR_IMMICH_PORT_DB:-5432}:5432
    restart: always
    shm_size: 128mb
    volumes:
      - ${ATHRADIR_IMMICH_PATH:-./immich}/db:/var/lib/postgresql/data
    deploy:
      placement:
        constraints: [node.hostname == butharad]

networks:
  gulhir:
    external: true

volumes:
  gogiwnadh-paperless-media:
    driver: local
    driver_opts:
      type: nfs
      o: addr=${NFS_IP},${NFS_OPTIONS}
      device: :${GOGIWNADH_PATH}/73.Documents/73.01.Paperless/media
  gogiwnadh-paperless-import:
    driver: local
    driver_opts:
      type: nfs
      o: addr=${NFS_IP},${NFS_OPTIONS}
      device: :${GOGIWNADH_PATH}/73.Documents/73.01.Paperless/import
